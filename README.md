Desktop Agent (MVP M0)

Demo Site: https://axion-inc.github.io/DesktopAgent/

![CI](https://github.com/Axion-inc/DesktopAgent/actions/workflows/ci.yml/badge.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

CI: https://github.com/Axion-inc/DesktopAgent/actions
Badges (after deploying /metrics):
- Success rate: `![Success](https://img.shields.io/endpoint?url=https://YOUR_HOST/metrics&label=success&query=$.success_rate&suffix=%25)`
- Runs: `![Runs](https://img.shields.io/endpoint?url=https://YOUR_HOST/metrics&label=runs&query=$.total_runs)`

Purpose: A minimal, local-only desktop AI agent for macOS 14+ that automates Finder file organization, PDF merge/extract, and creates a draft in Mail.app, with screenshots and a public dashboard. Designed for future Windows 11 support with adapter abstractions.

Quickstart (macOS 14+)
- Prereqs: Python 3.11+, Xcode CLT, permissions for Screen Recording and Automation.
- Setup:
  - `python3 -m venv venv`
  - `source venv/bin/activate`
  - `pip install -r requirements.txt`
  - `uvicorn app.main:app --reload`

Open http://127.0.0.1:8000
Health check: http://127.0.0.1:8000/healthz

Screenshots (Demo)
![Run Timeline](docs/assets/runs_timeline.svg)
![Public Dashboard](docs/assets/dashboard.svg)

Notes
- Sample PDFs are self-generated by `scripts/dev_setup_macos.sh` and are license-safe dummy files.
- Set `PERMISSIONS_STRICT=1` to block runs when Screen Recording is not granted (default is warn-only).

Permissions (macOS)
- **Screen Recording**: System Settings → Privacy & Security → Screen Recording → allow Terminal and your Python.
  - Diagram: docs/assets/permissions_screen_recording.svg
- **Automation (Mail, Finder, System Events)**: First run will prompt; or enable under Privacy & Security → Automation.
  - Diagram: docs/assets/permissions_automation.svg
- **Diagnostic UI**: Visit `/permissions` for real-time permission status and step-by-step fix instructions.
- **Blocking Mode**: Set `PERMISSIONS_STRICT=1` to block execution when permissions are missing (default: warning only).

Flow
- Plans → Dry-run (preview) → Approve → Execute → Replay (with screenshots) → Public dashboard.

Run the Template Plan
- Navigate to /plans/new, keep the default weekly report YAML, validate, approve, and run.

Sample PDFs
- 10 dummy PDFs are bundled via generator; run `scripts/dev_setup_macos.sh` to (re)materialize them into `sample_data/` safely (license-free).

Windows Roadmap (stubs included)
- Mail via Outlook `win32com` (compose, attach, save draft)
- Preview alternative via `os.startfile`
- Future: UI Automation (UIA) for richer flows

CI
- GitHub Actions runs flake8 and pytest on push.

Metrics / Badges
- `/metrics` exposes extended JSON with 24h p95 and 7d rolling stats suitable for Shields.io and dashboards.
  - Example schema:
    {
      "success_rate_24h": 0.94,
      "median_duration_ms_24h": 18200,
      "p95_duration_ms_24h": 41000,
      "top_errors_24h": [
        {"cluster": "PDF_PARSE_ERROR", "count": 3},
        {"cluster": "NO_FILES_FOUND", "count": 2},
        {"cluster": "PERMISSION_BLOCKED", "count": 1}
      ],
      "rolling_7d": {"success_rate": 0.93, "median_duration_ms": 19000}
    }

Security & Privacy
- No external LLM/API calls. Public pages mask PII (emails, names, file paths).

Troubleshooting (macOS)

**Permissions Issues**
- **Access `/permissions`** for real-time diagnostics and step-by-step fix instructions
- **Screen Recording**: Black screenshots or blank captures → System Settings → Privacy & Security → Screen Recording → add Terminal/Python
- **Mail Automation**: "Not authorized" errors → System Settings → Privacy & Security → Automation → Terminal → Mail (enable)
- **Strict Mode**: Set `PERMISSIONS_STRICT=1` to block execution instead of warning

**Common Failures**
- **"No files found"** → Check query syntax and root paths in `find_files` steps
- **PDF errors** → Ensure input files exist and are valid PDFs
- **Path errors** → Use `~/` for home directory expansion, check file existence
- **AppleScript Mail** → Launch Mail.app once manually, then retry

**Self-Recovery Features** (v1.1)
- **Auto-directory creation**: `move_to` creates missing output folders automatically
- **Search expansion**: `find_files` with 0 results widens search by one level (once)
- **Replay tracking**: Recovery actions are logged in step diffs for visibility

**Logs & Debugging**
- Step-by-step logs appear in `/runs/{id}` with input/output/screenshots
- Error details with line numbers in validation failures
- Use `--dry-run` mode for safe testing without file operations

License
- MIT

CLI Usage (headless)
- Single run of the weekly template in dry-run mode with sample data:
  - `python scripts/run_plan.py plans/templates/weekly_report.yaml --dry-run --var inbox=./sample_data --var workdir=./data/work --var out_pdf=./data/weekly.pdf`
- Seed 20 runs (dry-run) to validate stability:
  - `python scripts/seed_runs.py plans/templates/weekly_report.yaml --dry-run --n 20 --var inbox=./sample_data --var workdir=./data/work --var out_pdf=./data/weekly.pdf`
- Seed 20 runs (REAL) to record in /runs (opens Preview, creates Mail drafts):
  - `python scripts/seed_runs_real.py plans/templates/weekly_report.yaml --n 20 --sleep 1 --var inbox=./sample_data --var workdir=./data/work --var out_pdf=./data/weekly.pdf`
  - Optional: `export PERMISSIONS_STRICT=1` to block if Screen Recording is missing.

Shields.io Badges
- Example (replace URL with your deployment):
  - Success rate: `https://img.shields.io/endpoint?url=https://your.host/metrics&label=success&query=$.success_rate&suffix=%25`
  - Total runs: `https://img.shields.io/endpoint?url=https://your.host/metrics&label=runs&query=$.total_runs`

DSL v1.1 Features
- **Version Declaration**: Plans must start with `dsl_version: "1.1"`
- **Conditional Execution**: `when:` expressions support step references like `"{{steps[0].found}} > 0"`
- **Step Output Access**: Reference previous step results via `{{steps[i].field}}` (e.g., `{{steps[0].found}}`, `{{steps[3].page_count}}`)
- **Static Validation**: Prevents referencing future steps in `when` conditions (compile-time check)
- **Self-Recovery**: Auto-directory creation (`move_to`) and search expansion (`find_files`) with replay tracking
- **Enhanced Templates**: 
  - `weekly_report.yaml` - Updated for v1.1 with conditional steps
  - `weekly_report_split.yaml` - PDF merge → extract → digest workflow  
  - `downloads_tidy.yaml` - Automated file organization with pattern matching

Permissions (Blocking UI)
- `/permissions` shows current status; approval blocks if Mail Automation is denied (and optionally Screen Recording with `PERMISSIONS_STRICT=1`).
