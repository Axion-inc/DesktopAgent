dsl_version: "1.1"
name: "週次PDFレポート作成 → 下書きメール"
variables:
  inbox: "~/Downloads"
  workdir: "~/Reports/inbox"
  out_pdf: "~/Reports/weekly_{{date}}.pdf"
steps:
  - find_files: { query: "kind:pdf modified:this week", roots: ["{{inbox}}"], limit: 100 }
  - rename: { rule: "{{date}}_{{index}}_{{basename}}", when: "{{steps[0].found}} > 0" }
  - move_to: { dest: "{{workdir}}", when: "{{steps[0].found}} > 0" }
  - pdf_merge: { inputs_from: "{{workdir}}", out: "{{out_pdf}}", when: "{{steps[0].found}} > 0" }
  - pdf_extract_pages: { input: "{{out_pdf}}", pages: "1,3-5", out: "{{out_pdf | replace:'.pdf','_digest.pdf'}}", when: "{{steps[0].found}} > 0" }
  - open_preview: { path: "{{out_pdf}}" }
  - compose_mail:
      to: ["ops@example.com"]
      subject: "週次レポート {{date}}"
      body: "自動作成しました。成功率: {{metrics.success_rate}}%"
  - attach_files: { paths: ["{{out_pdf}}"] }
  - save_draft: {}
