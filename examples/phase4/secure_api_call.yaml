# Phase 4 Example: Secure API Call with HITL Approval
# This template demonstrates Phase 4 key features:
# - Secrets management ({{secrets://}} syntax)
# - HITL approval workflow
# - Queue/Priority configuration
# - Retry policies

dsl_version: "1.1"
name: "Secure Production API Call"

# Phase 4: Execution Policy
execution:
  queue: "high-priority"      # Execute in high priority queue
  priority: 2                 # Priority 2 (1 is highest)
  concurrency_tag: "api-ops"  # Concurrency limit for similar operations
  retry:
    max_attempts: 3
    backoff_multiplier: 2.0
    only_idempotent: true

steps:
  # Step 1: Pre-execution confirmation
  - human_confirm:
      message: "Execute production API call. Continue?"
      details:
        - "Target: Production API"
        - "Impact: Data updates included"
        - "Executor: {{user.name}}"
      timeout_minutes: 30
      auto_action: "deny"       # Auto-deny on timeout
      required_role: "Editor"   # Requires Editor permissions or higher

  # Step 2: Obtain API authentication token
  - make_request:
      url: "https://auth.api.example.com/token"
      method: "POST"
      headers:
        Content-Type: "application/json"
      data:
        client_id: "{{secrets://client_id}}"
        client_secret: "{{secrets://client_secret}}"
        grant_type: "client_credentials"
      store_result: "auth_response"

  # Step 3: Main API call
  - make_request:
      url: "https://api.example.com/v1/data"
      method: "POST"
      headers:
        Authorization: "Bearer {{auth_response.access_token}}"
        Content-Type: "application/json"
        X-API-Key: "{{secrets://api_key}}"
      data:
        action: "update_records"
        batch_id: "{{variables.batch_id}}"
        records: "{{variables.records}}"
      timeout_seconds: 60
      store_result: "api_response"

  # Step 4: Result verification
  - assert_text:
      contains: "success"
      source: "{{api_response.status}}"
      
  # Step 5: Audit log recording
  - log_event:
      level: "INFO" 
      message: "API call completed successfully"
      details:
        batch_id: "{{variables.batch_id}}"
        records_processed: "{{api_response.processed_count}}"
        execution_time: "{{metrics.duration_ms}}"

# Example runtime variables:
# variables:
#   batch_id: "2024-001"
#   records: 
#     - id: 1, name: "Record 1"
#     - id: 2, name: "Record 2"