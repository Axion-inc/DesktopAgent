<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Permission Diagnostics</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', roboto, oxygen, ubuntu, cantarell, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
    }
    .permission-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      transition: border-color 0.2s;
    }
    .permission-card.ok {
      border-color: #10b981;
      background: #f0fdf4;
    }
    .permission-card.warn {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .permission-card.fail {
      border-color: #ef4444;
      background: #fef2f2;
    }
    .permission-card.na {
      border-color: #6b7280;
      background: #f9fafb;
    }
    .status-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    .permission-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .permission-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    .permission-message {
      margin: 8px 0;
      line-height: 1.5;
    }
    .fix-steps {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }
    .fix-steps ol {
      margin: 0;
      padding-left: 20px;
    }
    .fix-steps li {
      margin: 8px 0;
    }
    .refresh-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px 8px 0 0;
    }
    .refresh-btn:hover {
      background: #2563eb;
    }
    .back-btn {
      background: #6b7280;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      display: inline-block;
    }
    .back-btn:hover {
      background: #4b5563;
    }
    .overall-status {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: 600;
    }
    .overall-status.ok {
      background: #d1fae5;
      color: #065f46;
    }
    .overall-status.warn {
      background: #fef3c7;
      color: #92400e;
    }
    .overall-status.fail {
      background: #fecaca;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <h1>ğŸ” macOS Permission Diagnostics</h1>
  
  {% set overall_status = "ok" %}
  {% for perm in perms.values() %}
    {% if perm.status == "fail" %}
      {% set overall_status = "fail" %}
    {% elif perm.status == "warn" and overall_status != "fail" %}
      {% set overall_status = "warn" %}
    {% endif %}
  {% endfor %}
  
  <div class="overall-status {{ overall_status }}">
    {% if overall_status == "ok" %}
      âœ… ã™ã¹ã¦ã®æ¨©é™ãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™
    {% elif overall_status == "warn" %}
      âš ï¸ ä¸€éƒ¨ã®æ¨©é™ã«å•é¡ŒãŒã‚ã‚Šã¾ã™
    {% else %}
      ğŸš¨ å¿…è¦ãªæ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ - å®Ÿè¡ŒãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™
    {% endif %}
  </div>
  
  {% for name, perm in perms.items() %}
    <div class="permission-card {{ perm.status }}">
      <div class="permission-header">
        <span class="status-icon">
          {% if perm.status == "ok" %}âœ…
          {% elif perm.status == "warn" %}âš ï¸
          {% elif perm.status == "fail" %}âŒ
          {% else %}â–{% endif %}
        </span>
        <h3 class="permission-title">
          {% if name == "screen_recording" %}
            Screen Recording
          {% elif name == "automation_mail" %}
            Mail Automation
          {% else %}
            {{ name }}
          {% endif %}
        </h3>
      </div>
      
      <p class="permission-message">{{ perm.message }}</p>
      
      {% if perm.status in ["warn", "fail"] %}
        <div class="fix-steps">
          <strong>ğŸ”§ ä¿®æ­£æ–¹æ³•:</strong>
          {% if name == "screen_recording" %}
            <ol>
              <li>ã€Œã‚·ã‚¹ãƒ†ãƒ è¨­å®šã€(System Settings) ã‚’é–‹ã</li>
              <li>ã€Œãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€(Privacy & Security) ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
              <li>ã€Œç”»é¢åéŒ²ã€(Screen Recording) ã‚’é¸æŠ</li>
              <li>DesktopAgent ã¾ãŸã¯ Terminal ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹</li>
              <li>ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„</li>
            </ol>
          {% elif name == "automation_mail" %}
            <ol>
              <li>ã€Œã‚·ã‚¹ãƒ†ãƒ è¨­å®šã€(System Settings) ã‚’é–‹ã</li>
              <li>ã€Œãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€(Privacy & Security) ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
              <li>ã€Œè‡ªå‹•åŒ–ã€(Automation) ã‚’é¸æŠ</li>
              <li>DesktopAgent ã¾ãŸã¯ Terminal â†’ Mail ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹</li>
              <li>Mail ã‚¢ãƒ—ãƒªã‚’ä¸€åº¦èµ·å‹•ã—ã¦ãã ã•ã„</li>
            </ol>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endfor %}
  
  <div style="margin-top: 30px;">
    <button class="refresh-btn" onclick="window.location.reload()">ğŸ”„ å†æ¤œæŸ»</button>
    <a href="/" class="back-btn">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    {% if run_id %}
      <a href="/runs/{{ run_id }}" class="back-btn">ğŸ“‹ å®Ÿè¡Œãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    {% endif %}
  </div>
  
  <hr style="margin: 40px 0;">
  <details>
    <summary>ğŸ” è©³ç´°æƒ…å ±</summary>
    <pre style="background: #f3f4f6; padding: 16px; border-radius: 8px; overflow-x: auto;">{{ perms | tojson(indent=2) }}</pre>
  </details>
</body>
</html>