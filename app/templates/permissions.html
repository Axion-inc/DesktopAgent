<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Permission Diagnostics</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', roboto, oxygen, ubuntu, cantarell, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
    }
    .permission-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      transition: border-color 0.2s;
    }
    .permission-card.ok {
      border-color: #10b981;
      background: #f0fdf4;
    }
    .permission-card.warn {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .permission-card.fail {
      border-color: #ef4444;
      background: #fef2f2;
    }
    .permission-card.na {
      border-color: #6b7280;
      background: #f9fafb;
    }
    .status-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    .permission-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .permission-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    .permission-message {
      margin: 8px 0;
      line-height: 1.5;
    }
    .fix-steps {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }
    .fix-steps ol {
      margin: 0;
      padding-left: 20px;
    }
    .fix-steps li {
      margin: 8px 0;
    }
    .refresh-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px 8px 0 0;
    }
    .refresh-btn:hover {
      background: #2563eb;
    }
    .back-btn {
      background: #6b7280;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      display: inline-block;
    }
    .back-btn:hover {
      background: #4b5563;
    }
    .overall-status {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 18px;
      font-weight: 600;
    }
    .overall-status.ok {
      background: #d1fae5;
      color: #065f46;
    }
    .overall-status.warn {
      background: #fef3c7;
      color: #92400e;
    }
    .overall-status.fail {
      background: #fecaca;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <h1>🔐 macOS Permission Diagnostics</h1>
  
  {% set overall_status = "ok" %}
  {% for perm in perms.values() %}
    {% if perm.status == "fail" %}
      {% set overall_status = "fail" %}
    {% elif perm.status == "warn" and overall_status != "fail" %}
      {% set overall_status = "warn" %}
    {% endif %}
  {% endfor %}
  
  <div class="overall-status {{ overall_status }}">
    {% if overall_status == "ok" %}
      ✅ すべての権限が正常に設定されています
    {% elif overall_status == "warn" %}
      ⚠️ 一部の権限に問題があります
    {% else %}
      🚨 必要な権限が不足しています - 実行がブロックされます
    {% endif %}
  </div>
  
  {% for name, perm in perms.items() %}
    <div class="permission-card {{ perm.status }}">
      <div class="permission-header">
        <span class="status-icon">
          {% if perm.status == "ok" %}✅
          {% elif perm.status == "warn" %}⚠️
          {% elif perm.status == "fail" %}❌
          {% else %}➖{% endif %}
        </span>
        <h3 class="permission-title">
          {% if name == "screen_recording" %}
            Screen Recording
          {% elif name == "automation_mail" %}
            Mail Automation
          {% else %}
            {{ name }}
          {% endif %}
        </h3>
      </div>
      
      <p class="permission-message">{{ perm.message }}</p>
      
      {% if perm.status in ["warn", "fail"] %}
        <div class="fix-steps">
          <strong>🔧 修正方法:</strong>
          {% if name == "screen_recording" %}
            <ol>
              <li>「システム設定」(System Settings) を開く</li>
              <li>「プライバシーとセキュリティ」(Privacy & Security) をクリック</li>
              <li>「画面収録」(Screen Recording) を選択</li>
              <li>DesktopAgent または Terminal にチェックを入れる</li>
              <li>アプリを再起動してください</li>
            </ol>
          {% elif name == "automation_mail" %}
            <ol>
              <li>「システム設定」(System Settings) を開く</li>
              <li>「プライバシーとセキュリティ」(Privacy & Security) をクリック</li>
              <li>「自動化」(Automation) を選択</li>
              <li>DesktopAgent または Terminal → Mail にチェックを入れる</li>
              <li>Mail アプリを一度起動してください</li>
            </ol>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endfor %}
  
  <div style="margin-top: 30px;">
    <button class="refresh-btn" onclick="window.location.reload()">🔄 再検査</button>
    <a href="/" class="back-btn">🏠 ホームに戻る</a>
    {% if run_id %}
      <a href="/runs/{{ run_id }}" class="back-btn">📋 実行ページに戻る</a>
    {% endif %}
  </div>
  
  <hr style="margin: 40px 0;">
  <details>
    <summary>🔍 詳細情報</summary>
    <pre style="background: #f3f4f6; padding: 16px; border-radius: 8px; overflow-x: auto;">{{ perms | tojson(indent=2) }}</pre>
  </details>
</body>
</html>